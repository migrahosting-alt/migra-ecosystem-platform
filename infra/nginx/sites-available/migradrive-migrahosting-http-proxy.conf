# /etc/nginx/sites-available/migradrive-migrahosting-http-proxy.conf
# SRV1 front-door: temporary HTTP vhost(s) to support ACME HTTP-01 and proxy to k3s ingress LB.
# After NAT is pointed to SRV1, run certbot --nginx for these hostnames.

server {
  listen 80;
  listen [::]:80;

  server_name migradrive.migrahosting.com console.migradrive.migrahosting.com;

  access_log /var/log/nginx/migradrive-migrahosting.http.access.log;
  error_log  /var/log/nginx/migradrive-migrahosting.http.error.log;

  location /.well-known/acme-challenge/ {
    root /var/www/html;
  }

  location / {
    proxy_http_version 1.1;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    # Ingress uses X-Forwarded-Proto for ssl-redirect decisions.
    # Always present as https because SRV1 is the front-door TLS terminator.
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-Port 443;

    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    proxy_read_timeout 300;
    proxy_send_timeout 300;

    # Ingress for these hosts enforces ssl-redirect; proxying to :80 causes 308 loops.
    # Re-encrypt on LAN to the ingress LB.
    proxy_ssl_server_name on;
    proxy_ssl_name $host;
    proxy_ssl_verify off;

    proxy_pass https://10.1.10.240;
  }
}
